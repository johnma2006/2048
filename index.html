<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>2048 AI</title>
    <style type="text/css">
        body {
            background-color: #EDEDED;
        }

    </style>

</head>
<body>
    
    <canvas id="canvas1" width="920" height="580" style="border:0px solid #c3c3c3; margin-left:27%;margin-top:40px" oncontextmenu="return false;"></canvas>
    
    <script>

        /* Todo: 
            -badBoardThresholdConstant proportional to derivative of score
        */

        var c;
        var ctx;

        var randomPieceLocation;
        var randomPiece;
        var probabilityOf2 = 0.9;

        var height = 141;
        var biggerHeight = 170;
        var biggerHeightAI = 160;
        var boxHeight = Array();
        var fontSize = 80;
        var lineWidth = 16;

        var board = Array();
        var boardOffset = Array();
        var boardOffset2 = Array();
        var tempBoard = Array();

        var transition = -1;
        var offsetX = 0;
        var offsetY = 0;
        var velocity = 14;
        var movable = 0;
        var heightVelocity = 1;

        var activeAI = 0;
        var badBoardThreshold = 1.0; //256 - >132, roughly cuts in half
        var badBoardThresholdConstant = 0.02; // 0.02
        var finishedAnimating = 1;
        var controllingAddedTiles = 0;

        var colour = "Default";

        var probabilityOfLosing = 0;
        var probabilityOfHavingLost = 0;
        var secondColOff = 0;

        var debug = "";
        var debug2 = "";
        var moves = 0;
        var pMoves = 0;
        var deepMoves = 0;

        function doKeyDown(evt) {
            switch (evt.keyCode) {
                case 38: //Up
                    controllingAddedTiles = 0;
                    updateBoard();
                    move("up");
                    break;
                case 40: //Down
                    controllingAddedTiles = 0;
                    updateBoard();
                    move("down");
                    break;
                case 37: //Left
                    controllingAddedTiles = 0;
                    updateBoard();
                    move("left");
                    break;
                case 39: //Right
                    controllingAddedTiles = 0;
                    updateBoard();
                    move("right");
                    break;
                    
                case 87: //W
                    debug = "U: (" + getMaxMinScore(board, "up", 3) + ", " + getMaxMinScoreProbability(board, "up", 3) + ")";
                    break;
                case 83: //S
                    debug = "D: (" + getMaxMinScore(board, "down", 3) + ", " + getMaxMinScoreProbability(board, "down", 3) + ")";
                    break;
                case 65: //A
                    debug = "L: (" + getMaxMinScore(board, "left", 3) + ", " + getMaxMinScoreProbability(board, "left", 3) + ")";
                    break;
                case 68: //D    
                    debug = "R: (" + getMaxMinScore(board, "right", 3) + ", " + getMaxMinScoreProbability(board, "right", 3) + ")";
                    break;

                case 70: //F
                    controllingAddedTiles = 0;
                    bestMove = getBestMove(board, 4);
                    move(bestMove);
                    break;
                case 71: //G
                    controllingAddedTiles = 0;
                    activeAI = 1;

                    break;
                case 72: //H
                    controllingAddedTiles = 0;
                    activeAI = 0;
                    break;

                case 49: //1
                    colour = "Default";
                    break;
                case 50: //2
                    colour = "Pink";
                    break;
                case 51: //3
                    colour = "Pink";
                    break;

                
            }
        }
        function initialize() {

            c = document.getElementById("canvas1");
            ctx = c.getContext("2d");

            initializeBoard();
            drawBoard();

            return setInterval(draw, 10);

        }
        function initializeBoard() {
            for (var i = 0; i < 4; i++) {
                //board = [[2048, 1024, 128, 2], [0, 0, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0]];
                //board = [[1024, 512, 2, 32], [2, 2, 128, 4], [0, 2, 4, 0], [0, 0, 0, 0]];
                //board = [[1024, 512, 128, 64], [64, 128, 256, 8], [16, 32, 0, 0], [2, 8, 4, 0]];
                //board = [[2, 256, 0, 2], [4, 4, 0, 0], [2, 0, 0, 0], [0, 0, 0, 0]];

                board[i] = [0, 0, 0, 0];
                boardOffset[i] = [0, 0, 0, 0];
                boardOffset2[i] = [0, 0, 0, 0];
                boxHeight[i] = [height, height, height, height];
            }
            addRandomPiece();
            addRandomPiece();

            tempBoard = Array();
            for (var i = 0; i < 4; i++)
                tempBoard.push(board[i].slice());

        }

        //Drawing functions
        function drawBoard() {
            if (colour == "Default") {
                ctx.fillStyle = "#B7AFA3";
                document.body.style.backgroundColor = "#EDEDED";
            }
            else if (colour == "Blue") {
                ctx.fillStyle = "#A57FA5";
                document.body.style.backgroundColor = "#FFF0F5";
            }
            else if (colour == "Pink") {
                ctx.fillStyle = "#A57FA5";
                document.body.style.backgroundColor = "#FFF0F5";
            }
            ctx.fillRect(0, 0, height * 4 + lineWidth, height * 4 + lineWidth);
        }
        function draw() {
            ctx.clearRect(0, 0, 1000, 1000);
            drawBoard();
            if (transition > 0 && transition < height)
                transition += velocity;
            else if (transition >= height) {
                transition = -1;
                for (var i = 0; i < 4; i++)
                    for (var j = 0; j < 4; j++)
                        if (boxHeight[i][j] == height + 1) {
                            if (activeAI == 0)
                                boxHeight[i][j] = biggerHeight;
                            if (activeAI == 1)
                                boxHeight[i][j] = biggerHeightAI;
                        }
                updateBoard();
            }

            for (var i = 0; i < 4; i++)
                for (var j = 0; j < 4; j++) {
                    if (boxHeight[i][j] < height)
                        boxHeight[i][j] = 0.75 * boxHeight[i][j] + 0.25 * height;
                    else if (boxHeight[i][j] > height && boxHeight[i][j] != height + 1) {
                        boxHeight[i][j] = 0.85 * boxHeight[i][j] + 0.15 * height;
                        if (boxHeight[i][j] > height + 1 && boxHeight[i][j] < height + 2 && (boxHeight < height && boxHeight > height - 5))
                            boxHeight[i][j] = height;
                    }
                }

            drawPieces();

            if (finishedAnimating == 0) {
                finishedAnimating = 1;
                for (var i = 0; i < 4; i++)
                    for (var j = 0; j < 4; j++)
                        if (boxHeight[i][j] != height)
                            finishedAnimating = 0;
            }

            if (finishedAnimating > 0)
                finishedAnimating++;

            /*debug = finishedAnimating;
            
            var emptySpaces = 0;
            for (var i = 0; i < 4; i++)
                for (var j = 0; j < 4; j++)
                    if (board[i][j] == 0)
                        emptySpaces++;

            var changeInAnimationTime = (emptySpaces - 14) * (emptySpaces - 16) / 5*/

            if (activeAI == 1 && transition == -1) {
                if (finishedAnimating > 3) {
                    finishedAnimating = 0;
                    //var bestMove = getBestMove(board, 3);
                    //if (board[2][3] > 4 && generateMove(board, bestMove)[2][3] == 0 && bestMove == "up")
                       // activeAI = 0;
                    //else
                    if (probabilityOfLosing < 0.05)
                        move(getBestMove(board, 3));
                    else {
                        move(getBestMove(board, 4));
                        deepMoves++;
                    }

                }
            }

            ctx.fillStyle = "#000000";
            ctx.font = "bold 40px Calibri";
            ctx.fillText("2048 AI", 610, 40);

            ctx.font = "20px Calibri";
            ctx.fillText("by John Ma", 610, 70);

            ctx.font = "bold 20px Calibri";
            ctx.fillText("Arrow keys to move", 610, 140);
            ctx.fillText("G/H to start/stop AI", 610, 170);
            ctx.fillText("Left/right click a tile to place 2/4", 610, 200);
            ctx.font = "14px Calibri";
            ctx.fillText("(Try to make the computer lose)", 610, 220);
            ctx.font = "bold 20px Calibri";
            ctx.fillText("1/2 to change theme", 610, 250);

            ctx.font = "14px Calibri"; 

            ctx.fillText("moves: " + moves, 610, 470);
            ctx.fillText("(pMoves, deepMoves): (" + pMoves + ", " + deepMoves + ")", 610, 490);
            ctx.fillText("score(board): " + score(board), 610, 510);
            ctx.fillText("p(Lost): " + Math.floor(probabilityOfHavingLost * 10000) / 100 + "%", 610, 530);
            ctx.fillText("secondColOff: " + secondColOff, 610, 550);

            ctx.fillText(debug, 610, 570);
            ctx.fillText(debug2, 610, 590);

        }
        function drawPieces() {
            for (var i = 0; i < 4; i++) 
                for (var j = 0; j < 4; j++) {
                    //Draw background pieces
                    ctx.fillStyle = getTileColour(-1, -1);
                    ctx.fillRect(i * height + lineWidth, j * height + lineWidth, height - lineWidth, height - lineWidth);
                }

            for (var i = 0; i < 4; i++) {
                for (var j = 0; j < 4; j++) {
                    //Draw pieces
                    if (board[i][j] != 0) {
                        ctx.fillStyle = getTileColour(i, j);

                        if (offsetX == 1)
                            ctx.fillRect(i * height + lineWidth + transition * boardOffset[i][j] - 0.5 * (boxHeight[i][j] - height),
                                j * height + lineWidth - 0.5 * (boxHeight[i][j] - height),
                                boxHeight[i][j] - lineWidth,
                                boxHeight[i][j] - lineWidth);
                        else
                            ctx.fillRect(i * height + lineWidth - 0.5 * (boxHeight[i][j] - height),
                                        j * height + lineWidth + transition * boardOffset[i][j] - 0.5 * (boxHeight[i][j] - height),
                                        boxHeight[i][j] - lineWidth,
                                        boxHeight[i][j] - lineWidth);

                        //Draw text
                        if (board[i][j] != 0) {

                            if (board[i][j] < 10)
                                fontSize = 80;
                            else if (board[i][j] < 100)
                                fontSize = 70;
                            else if (board[i][j] < 1000)
                                fontSize = 60;
                            else if (board[i][j] < 10000)
                                fontSize = 50;

                            ctx.fillStyle = getTextColour(i, j);

                            fontSize = boxHeight[i][j] / height * fontSize;

                            ctx.font = "bold " + fontSize + "px Calibri";

                            var txt = board[i][j];
                            textWidth = ctx.measureText(txt).width;

                            if (offsetX == 1)
                                ctx.fillText(txt, i * height + 0.5 * (height + lineWidth - textWidth) + transition * boardOffset[i][j], j * height + 0.5 * height + 0.4 * fontSize);
                            else
                                ctx.fillText(txt, i * height + 0.5 * (height + lineWidth - textWidth), j * height + 0.5 * height + 0.4 * fontSize + transition * boardOffset[i][j]);

                        }
                    }

                    
                }
            }
        }
        function getTileColour(i, j) {
            if (colour == "Default") {
                if (i == -1)
                    return "#E8D0A9";
                if (board[i][j] == 2)
                    return "#F5FAFA";
                else if (board[i][j] == 4)
                    return "#C1DAD6";
                else if (board[i][j] == 8)
                    return "#ACD1E9";
                else if (board[i][j] == 16)
                    return "#6D929B";
                else if (board[i][j] == 32)
                    return "#7F7A65";
                else if (board[i][j] == 64)
                    return "#FFB346";
                else if (board[i][j] == 128)
                    return "#CC8F38";
                else if (board[i][j] == 256)
                    return "#7F5923";
                else if (board[i][j] == 512)
                    return "#5E5241";
                else if (board[i][j] == 1024)
                    return "#7F6949";
                else if (board[i][j] == 2048)
                    return "#678470";
                else if (board[i][j] == 4096)
                    return "#65A4C7";
                else
                    return "#6581C7";
            }
            else if (colour == "Blue") {
                if (i == -1)
                    return "#D8BFD8";
                if (board[i][j] == 2)
                    return "#EEE0E5";
                else if (board[i][j] == 4)
                    return "#FFB5C5";
                else if (board[i][j] == 8)
                    return "#CD6889";
                else if (board[i][j] == 16)
                    return "#CD919E";
                else if (board[i][j] == 32)
                    return "#DB7093";
                else if (board[i][j] == 64)
                    return "#FF82AB";
                else if (board[i][j] == 128)
                    return "#EE799F";
                else if (board[i][j] == 256)
                    return "#CD6889";
                else if (board[i][j] == 1024)
                    return "#8B475D";
                else if (board[i][j] == 2048)
                    return "#FF3E96";
                else
                    return "#FF6EB4";
            }
            else if (colour == "Pink") {
                if (i == -1)
                    return "#D8BFD8";
                if (board[i][j] == 2)
                    return "#EEE0E5";
                else if (board[i][j] == 4)
                    return "#FFB5C5";
                else if (board[i][j] == 8)
                    return "#CD6889";
                else if (board[i][j] == 16)
                    return "#CD919E";
                else if (board[i][j] == 32)
                    return "#DB7093";
                else if (board[i][j] == 64)
                    return "#FF82AB";
                else if (board[i][j] == 128)
                    return "#EE799F";
                else if (board[i][j] == 256)
                    return "#CD6889";
                else if (board[i][j] == 512)
                    return "#CC869D";
                else if (board[i][j] == 1024)
                    return "#8B475D";
                else if (board[i][j] == 2048)
                    return "#FF3E96";
                else if (board[i][j] == 4096)
                    return "#FF4FBB";
                else
                    return "#FF6EB4";
            }
        }
        function getTextColour(i, j) {
            if (colour == "Default") {
                if (board[i][j] == 2)
                    return "#191919";
                else if (board[i][j] == 4)
                    return "#363D3C";
                else if (board[i][j] == 8)
                    return "#313B42";
                else
                    return "#EEEEEE";
            }
            else if (colour == "Blue") {
                if (board[i][j] == 2)
                    return "#2B0C1C";
                else
                    return "#EEEEEE";
            }
            else if (colour == "Pink") {
                if (board[i][j] == 2)
                    return "#2B0C1C";
                else
                    return "#EEEEEE";
            }
    }

        //Game functions
        function addRandomPiece() {
            var emptySpaces = 0;
            for (var i = 0; i < 4; i++)
                for (var j = 0; j < 4; j++)
                    if (board[i][j] == 0)
                        emptySpaces++;

            if (emptySpaces > 0) {
                var randomPieceLocation = Math.floor(Math.random() * emptySpaces) + 1;
                for (var i = 0; i < 4; i++)
                    for (var j = 0; j < 4; j++) {
                        if (board[i][j] == 0) {
                            randomPieceLocation--;
                            if (randomPieceLocation == 0) {
                                var randomPiece = Math.random();
                                if (randomPiece < probabilityOf2)
                                    board[i][j] = 2;
                                else
                                    board[i][j] = 4;
                                boxHeight[i][j] = 0;
                            }

                        }

                    }
            }
        }
        function move(direction) {
            movable = 0;

            tempBoard = Array();
            for (var i = 0; i < 4; i++)
                tempBoard.push(board[i].slice());

            if (direction == "up") {
                offsetX = 0;
                offsetY = 1;
                for (var i = 0; i < 4; i++) {
                    
                    for (var j = 1; j < 4; j++) {
                        if (tempBoard[i][j] != 0 && j > 0)
                            for (var k = j - 1; k >= 0; k--) {
                                if (tempBoard[i][k] == 0) {
                                    tempBoard[i][k] = tempBoard[i][k + 1];
                                    tempBoard[i][k + 1] = 0;
                                    movable = 1;
                                    boardOffset[i][j] -= 1;
                                }
                                else
                                    break;
                            }
                    }
                    var determined = 0;
                    if (tempBoard[i][0] == tempBoard[i][1] &&
                        tempBoard[i][0] == tempBoard[i][2] &&
                        tempBoard[i][0] == tempBoard[i][3]) {
                        boardOffset[i] = [0, -1, -1, -2];
                        boxHeight[i] = [height + 1, height, height + 1, height];
                        determined = 1;
                    }

                    for (var j = 0; j < 3; j++) {
                        if (tempBoard[i][j] == tempBoard[i][j + 1] && tempBoard[i][j] != 0) {
                            tempBoard[i][j] *= 2;
                            boardOffset2[i][j + 1] -= 1;
                            if (determined == 0)
                                boxHeight[i][j] = height + 1;
                            for (var k = j + 1; k < 3; k++) {
                                tempBoard[i][k] = tempBoard[i][k + 1];
                                if (determined == 0) 
                                    boardOffset2[i][k + 1] -= 1;
                            }
                            tempBoard[i][3] = 0;
                            movable = 1;
                            
                        }
                    }
                    
                }
                for (var i = 0; i < 4; i++) {
                    for (var j = 0; j < 4; j++) {
                        boardOffset[i][j] += boardOffset2[i][j + boardOffset[i][j]];
                    }
                }
            }
            if (direction == "down") {
                offsetX = 0;
                offsetY = 1;
                for (var i = 0; i < 4; i++) {

                    for (var j = 2; j >= 0; j--) {
                        if (tempBoard[i][j] != 0 && j < 3)
                            for (var k = j + 1; k <= 3; k++) {
                                if (tempBoard[i][k] == 0) {
                                    tempBoard[i][k] = tempBoard[i][k - 1];
                                    tempBoard[i][k - 1] = 0;
                                    movable = 1;
                                    boardOffset[i][j] += 1;
                                }
                                else
                                    break;
                            }
                    }

                    var determined = 0;
                    if (tempBoard[i][0] == tempBoard[i][1] &&
                        tempBoard[i][0] == tempBoard[i][2] &&
                        tempBoard[i][0] == tempBoard[i][3]) {
                        boardOffset[i] = [2, 1, 1, 0];
                        boxHeight[i] = [height, height + 1, height, height + 1];
                        determined = 1;
                    }

                    for (var j = 3; j > 0; j--) {
                        if (tempBoard[i][j] == tempBoard[i][j - 1] && tempBoard[i][j] != 0) {
                            tempBoard[i][j] *= 2;
                            boardOffset2[i][j - 1] += 1;
                            if (determined == 0)
                                boxHeight[i][j] = height + 1;
                            for (var k = j - 1; k > 0; k--) {
                                tempBoard[i][k] = tempBoard[i][k - 1];
                                if (determined == 0)
                                    boardOffset2[i][k - 1] += 1;
                            }
                            tempBoard[i][0] = 0;
                            movable = 1;

                        }
                    }
                }
                for (var i = 0; i < 4; i++) {
                    for (var j = 0; j < 4; j++) {
                        boardOffset[i][j] += boardOffset2[i][j + boardOffset[i][j]];
                    }
                }
            }
            if (direction == "left") {
                offsetX = 1;
                offsetY = 0;
                for (var j = 0; j < 4; j++) {

                    for (var i = 1; i < 4; i++) {
                        if (tempBoard[i][j] != 0 && i > 0)
                            for (var k = i - 1; k >= 0; k--) {
                                if (tempBoard[k][j] == 0) {
                                    tempBoard[k][j] = tempBoard[k + 1][j];
                                    tempBoard[k + 1][j] = 0;
                                    movable = 1;
                                    boardOffset[i][j] -= 1;
                                }
                                else
                                    break;
                            }
                    }

                    var determined = 0;
                    if (tempBoard[0][j] == tempBoard[1][j] &&
                        tempBoard[0][j] == tempBoard[2][j] &&
                        tempBoard[0][j] == tempBoard[3][j]) {
                        boardOffset[i] = [0, -1, -1, -2];
                        boxHeight[i] = [height + 1, height, height + 1, height];
                        determined = 1;
                    }

                    for (var i = 0; i < 3; i++) {
                        if (tempBoard[i][j] == tempBoard[i + 1][j] && tempBoard[i][j] != 0) {
                            tempBoard[i][j] *= 2;
                            boardOffset2[i + 1][j] -= 1;
                            if (determined == 0)
                                boxHeight[i][j] = height + 1;
                            for (var k = i + 1; k < 3; k++) {
                                tempBoard[k][j] = tempBoard[k + 1][j];
                                if (determined == 0)
                                    boardOffset2[k + 1][j] -= 1;
                            }
                            tempBoard[3][j] = 0;
                            movable = 1;

                        }
                    }
                }
                for (var i = 0; i < 4; i++) {
                    for (var j = 0; j < 4; j++) {
                        boardOffset[i][j] += boardOffset2[i + boardOffset[i][j]][j];
                    }
                }
            }
            if (direction == "right") {
                offsetX = 1;
                offsetY = 0;
                for (var j = 0; j < 4; j++) {

                    for (var i = 2; i >= 0; i--) {
                        if (tempBoard[i][j] != 0 )
                            for (var k = i + 1; k <= 3; k++) {
                                if (tempBoard[k][j] == 0) {
                                    tempBoard[k][j] = tempBoard[k - 1][j];
                                    tempBoard[k - 1][j] = 0;
                                    movable = 1;
                                    boardOffset[i][j] += 1;
                                }
                                else
                                    break;
                            }
                    }

                    var determined = 0;
                    if (tempBoard[0][j] == tempBoard[1][j] &&
                        tempBoard[0][j] == tempBoard[2][j] &&
                        tempBoard[0][j] == tempBoard[3][j]) {
                        boardOffset[i] = [2, 1, 1, 0];
                        boxHeight[i] = [height, height + 1, height, height + 1];
                        determined = 1;
                    }

                    for (var i = 3; i > 0; i--) {
                        if (tempBoard[i][j] == tempBoard[i - 1][j] && tempBoard[i][j] != 0) {
                            tempBoard[i][j] *= 2;
                            boardOffset2[i - 1][j] += 1;
                            if (determined == 0)
                                boxHeight[i][j] = height + 1;
                            for (var k = i - 1; k > 0; k--) {
                                tempBoard[k][j] = tempBoard[k - 1][j];
                                if (determined == 0)
                                    boardOffset2[k - 1][j] += 1;
                            }
                            tempBoard[0][j] = 0;
                            movable = 1;

                        }
                    }
                }
                for (var i = 0; i < 4; i++) {
                    for (var j = 0; j < 4; j++) {
                        boardOffset[i][j] += boardOffset2[i + boardOffset[i][j]][j];
                    }
                }
            }


            for (var i = 0; i < 4; i++) {
                for (var j = 0; j < 4; j++) {
                    if (board[i][j] == 0)
                        boardOffset[i][j] = 0;
                }
            }

            transition = 1;
           
            if (movable == 0 && activeAI == 1)
                activeAI = 0;

        }
        function updateBoard() {
            board = Array();

            for (var i = 0; i < 4; i++)
                board.push(tempBoard[i].slice());
            for (var i = 0; i < 4; i++) {
                boardOffset[i] = [0, 0, 0, 0];
                boardOffset2[i] = [0, 0, 0, 0];
            }

            if (movable == 1) {
                if (controllingAddedTiles == 0 || activeAI == 1)
                    addRandomPiece();
                movable = 0;
            }

            tempBoard = Array();
            for (var i = 0; i < 4; i++)
                tempBoard.push(board[i].slice());

            finishedAnimating = 1;
        }
        function addClickElementToBoard(ev) {
            var x = ev.clientX - c.offsetLeft;
            var y = ev.clientY - c.offsetTop;

            x = Math.floor(x / height);
            y = Math.floor(y / height);

            if (board[x][y] == 0) {
                controllingAddedTiles = 1;
                if (ev.which == 1)
                    board = generateAddElement(board, x, y, 2);
                else if (ev.which == 3)
                    board = generateAddElement(board, x, y, 4);
                move(getBestMove(board, 3));
            }
        }

        //AI functions
        function generateMove(newTestBoard, direction) {
            var movable2 = 0;
            var testBoard = Array();
            for (var i = 0; i < 4; i++)
                testBoard[i] = newTestBoard[i].slice();
            if (direction == "up") {
                for (var i = 0; i < 4; i++) {

                    for (var j = 0; j < 4; j++) {
                        if (testBoard[i][j] != 0 && j > 0)
                            for (var k = j - 1; k >= 0; k--) {
                                if (testBoard[i][k] == 0) {
                                    testBoard[i][k] = testBoard[i][k + 1];
                                    testBoard[i][k + 1] = 0;
                                    movable2 = 1;
                                }
                                else
                                    break;
                            }
                    }

                    for (var j = 0; j < 3; j++) {
                        if (testBoard[i][j] == testBoard[i][j + 1] && testBoard[i][j] != 0) {
                            testBoard[i][j] *= 2;
                            for (var k = j + 1; k < 3; k++)
                                testBoard[i][k] = testBoard[i][k + 1];
                            testBoard[i][3] = 0;
                            movable2 = 1;

                        }
                    }
                }
            }
            if (direction == "down") {
                for (var i = 0; i < 4; i++) {

                    for (var j = 2; j >= 0; j--) {
                        if (testBoard[i][j] != 0 && j < 3)
                            for (var k = j + 1; k <= 3; k++) {
                                if (testBoard[i][k] == 0) {
                                    testBoard[i][k] = testBoard[i][k - 1];
                                    testBoard[i][k - 1] = 0;
                                    movable2 = 1;
                                }
                                else
                                    break;
                            }
                    }

                    for (var j = 3; j > 0; j--) {
                        if (testBoard[i][j] == testBoard[i][j - 1] && testBoard[i][j] != 0) {
                            testBoard[i][j] *= 2;
                            for (var k = j - 1; k > 0; k--)
                                testBoard[i][k] = testBoard[i][k - 1];
                            testBoard[i][0] = 0;
                            movable2 = 1;

                        }
                    }
                }
            }
            if (direction == "left") {

                for (var j = 0; j < 4; j++) {

                    for (var i = 0; i < 4; i++) {
                        if (testBoard[i][j] != 0 && i > 0)
                            for (var k = i - 1; k >= 0; k--) {
                                if (testBoard[k][j] == 0) {
                                    testBoard[k][j] = testBoard[k + 1][j];
                                    testBoard[k + 1][j] = 0;
                                    movable2 = 1;
                                }
                                else
                                    break;
                            }
                    }

                    for (var i = 0; i < 3; i++) {
                        if (testBoard[i][j] == testBoard[i + 1][j] && testBoard[i][j] != 0) {
                            testBoard[i][j] *= 2;
                            for (var k = i + 1; k < 3; k++)
                                testBoard[k][j] = testBoard[k + 1][j];
                            testBoard[3][j] = 0;
                            movable2 = 1;

                        }
                    }
                }
            }
            if (direction == "right") {
                for (var j = 0; j < 4; j++) {
                    
                    for (var i = 2; i >= 0; i--) {
                        if (testBoard[i][j] != 0 && i < 3)
                            for (var k = i + 1; k <= 3; k++) {
                                if (testBoard[k][j] == 0) {
                                    testBoard[k][j] = testBoard[k - 1][j];
                                    testBoard[k - 1][j] = 0;
                                    movable2 = 1;
                                }
                                else
                                    break;
                            }
                    }
                    
                    for (var i = 3; i > 0; i--) {
                        if (testBoard[i][j] == testBoard[i - 1][j] && testBoard[i][j] != 0) {
                            testBoard[i][j] *= 2;
                            for (var k = i - 1; k > 0; k--)
                                testBoard[k][j] = testBoard[k - 1][j];
                            testBoard[0][j] = 0;
                            movable2 = 1;

                        }
                    }
                  
                }
            }
            if (movable2 == 0)
                return "False";
            else
                return testBoard;

        }
        function generateAddElement(newTestBoard, i, j, number) {
            if (newTestBoard[i][j] != 0) {
                return "False";
            }
            else {
                var testBoard = Array();
                for (var i2 = 0; i2 < 4; i2++)
                    testBoard[i2] = newTestBoard[i2].slice();

                testBoard[i][j] = number;

                return testBoard;
            }
        }
        function getBestMove(testBoard, iterations) {

            var testBoardUpScore = getMaxMinScore(testBoard, "up", iterations);
            var testBoardDownScore = getMaxMinScore(testBoard, "down", iterations);
            var testBoardLeftScore = getMaxMinScore(testBoard, "left", iterations);
            var testBoardRightScore = getMaxMinScore(testBoard, "right", iterations);

            var scores = [testBoardUpScore, testBoardDownScore, testBoardLeftScore, testBoardRightScore];
            scores.sort(function (a, b) { return b - a }); //biggest first
            
            if (scores[0] < badBoardThreshold * score(board) - badBoardThresholdConstant) {
                pMoves++;
                moves++;

                var testBoardUpProbability = getMaxMinScoreProbability(testBoard, "up", iterations);
                var testBoardDownProbability = getMaxMinScoreProbability(testBoard, "down", iterations);
                var testBoardLeftProbability = getMaxMinScoreProbability(testBoard, "left", iterations);
                var testBoardRightProbability = getMaxMinScoreProbability(testBoard, "right", iterations);

                var probabilities = [testBoardUpProbability, testBoardDownProbability, testBoardLeftProbability, testBoardRightProbability];
                probabilities.sort(function (a, b) { return b - a }); //biggest first
                if (scores[0] == -10) {
                    probabilityOfLosing = probabilities[3];
                    probabilityOfHavingLost = 1 - (1 - probabilityOfHavingLost) * (1 - probabilities[3]);
                }
                    //alert(probabilities[3]);

                for (var i = 3; i >= 0; i--) {

                    if (probabilities[i] == testBoardUpProbability && generateMove(board, "up") != "False")
                        return "up";
                    if (probabilities[i] == testBoardLeftProbability && generateMove(board, "left") != "False")
                        return "left";
                    if (probabilities[i] == testBoardDownProbability && generateMove(board, "down") != "False")
                        return "down";
                    if (probabilities[i] == testBoardRightProbability && generateMove(board, "right") != "False")
                        return "right";
                }
            }
            else {
                probabilityOfLosing = 0;
                moves++;
                for (var i = 0; i < 4; i++) {

                    if (scores[i] == testBoardUpScore && generateMove(board, "up") != "False")
                        return "up";
                    if (scores[i] == testBoardLeftScore && generateMove(board, "left") != "False")
                        return "left";
                    if (scores[i] == testBoardDownScore && generateMove(board, "down") != "False")
                        return "down";
                    if (scores[i] == testBoardRightScore && generateMove(board, "right") != "False")
                        return "right";
                }
            }
        }
        function getMaxMinScore(testBoard, direction, iterations) {

            if (iterations == 1) {
                return score(generateMove(testBoard, direction));
            }
            else {

                var newTestBoard = generateMove(testBoard, direction); //Make move

                if (newTestBoard == "False")
                    return -10;

                var arrayOfNewTestBoards = Array();

                for (var i = 0; i < 4; i++) //Add elements
                    for (var j = 0; j < 4; j++)
                        if (newTestBoard[i][j] == 0)
                            arrayOfNewTestBoards.push(generateAddElement(newTestBoard, i, j, 2));

                for (var i = 0; i < 4; i++)
                    for (var j = 0; j < 4; j++)
                        if (newTestBoard[i][j] == 0)
                            arrayOfNewTestBoards.push(generateAddElement(newTestBoard, i, j, 4));

                var arrayOfNewTestBoardScores = Array();

                for (var i = 0; i < arrayOfNewTestBoards.length; i++) {

                    var maxNumber = Math.max(getMaxMinScore(arrayOfNewTestBoards[i], "up", iterations - 1),
                                            getMaxMinScore(arrayOfNewTestBoards[i], "down", iterations - 1),
                                            getMaxMinScore(arrayOfNewTestBoards[i], "left", iterations - 1),
                                            getMaxMinScore(arrayOfNewTestBoards[i], "right", iterations - 1));


                    arrayOfNewTestBoardScores.push(maxNumber);
                }

                var minNumber = Math.min.apply(Math, arrayOfNewTestBoardScores);
                /*var avgNumber = 0;
    
                for (var i in arrayOfNewTestBoardScores)
                    if (isFinite(arrayOfNewTestBoardScores[i]))
                        avgNumber += arrayOfNewTestBoardScores[i];
    
                avgNumber /= arrayOfNewTestBoardScores.length;*/

                return minNumber;
            }
        }
        function getMaxMinScoreProbability(testBoard, direction, iterations) { //Returns probability of losing 

            if (iterations == 1) {

                if (score(generateMove(testBoard, direction)) < badBoardThreshold * score(board) - badBoardThresholdConstant)
                    return 1.0;
                else
                    return 0.0;
            }
            else {
                var probability = 0;

                var newTestBoard = generateMove(testBoard, direction); //Make move

                if (newTestBoard == "False") //Unable to make move = bad  
                    return 1.0;

                var arrayOfNewTestBoardsWith2s = Array();
                for (var i = 0; i < 4; i++) //Add elements
                    for (var j = 0; j < 4; j++)
                        if (newTestBoard[i][j] == 0)
                            arrayOfNewTestBoardsWith2s.push(generateAddElement(newTestBoard, i, j, 2));

                var arrayOfNewTestBoardsWith4s = Array();
                for (var i = 0; i < 4; i++)
                    for (var j = 0; j < 4; j++)
                        if (newTestBoard[i][j] == 0)
                            arrayOfNewTestBoardsWith4s.push(generateAddElement(newTestBoard, i, j, 4));

                for (var i = 0; i < arrayOfNewTestBoardsWith2s.length; i++) {

                    var p2 = Math.min(getMaxMinScoreProbability(arrayOfNewTestBoardsWith2s[i], "up", iterations - 1),
                                    getMaxMinScoreProbability(arrayOfNewTestBoardsWith2s[i], "down", iterations - 1),
                                    getMaxMinScoreProbability(arrayOfNewTestBoardsWith2s[i], "left", iterations - 1),
                                    getMaxMinScoreProbability(arrayOfNewTestBoardsWith2s[i], "right", iterations - 1));
                    p2 *= probabilityOf2 / arrayOfNewTestBoardsWith2s.length;

                    var p4 = Math.min(getMaxMinScoreProbability(arrayOfNewTestBoardsWith4s[i], "up", iterations - 1),
                                    getMaxMinScoreProbability(arrayOfNewTestBoardsWith4s[i], "down", iterations - 1),
                                    getMaxMinScoreProbability(arrayOfNewTestBoardsWith4s[i], "left", iterations - 1),
                                    getMaxMinScoreProbability(arrayOfNewTestBoardsWith4s[i], "right", iterations - 1));
                    p4 *= (1 - probabilityOf2) / arrayOfNewTestBoardsWith2s.length;

                    probability += p2 + p4;
                }

                return probability;
            }
        }
        function score(testBoard) {

            var score = 0;

            //Weighted sum of board. Columns 1 and 2 are snake.
            for (var j = 0; j < 4; j++) {
                if (!(j == 3 && board[0][2] >= 256))
                    score += testBoard[0][j] * Math.pow(3, -17 + 20 - j); //20 19 18 17 
                if (!(testBoard[1][3] < testBoard[1][2] && testBoard[0][2] >= 256 &&
                    (testBoard[1][2] <= 64 && testBoard[1][3] <= 32))) {
                    score += testBoard[1][j] * Math.pow(3, -17 + j + 10); //10 11 12 13
                    secondColOff = 0;
                }
            }
            
            //If it messed up 2nd column
            if (testBoard[1][3] < testBoard[1][2] && testBoard[0][2] >= 256 && testBoard[0][0] >= 2048 &&
                (testBoard[1][2] <= 64 && testBoard[1][3] <= 32)
                && testBoard[2][3] < testBoard[1][3]) {
                //score += testBoard[1][2] * Math.pow(3, -17 + 2 + 10); //12
                score += testBoard[1][3] * Math.pow(3, -17 + 3 + 10); //13
                score -= testBoard[1][2] / testBoard[1][3];
                secondColOff = 1;
            }

            //If it messed up 1st column
            if (testBoard[0][0] < testBoard[0][1] && testBoard[0][1] <= 256 && testBoard[1][0] <= 256) {
                score = 0;
                score += testBoard[0][0] * Math.pow(3, -17 + 20 - 0); //20
                score += testBoard[0][1] * Math.pow(3, -17 + 20 - 1); //19
                for (var j = 0; j < 4; j++) {
                    //score += testBoard[0][j] * Math.pow(3, -17 + 20 - j); //20 19 18 17 
                    score += testBoard[1][j] * Math.pow(3, -17 + (3 - j) + 10); //13 12 11 10
                }
            }

            //Columns 3 and 4 are dependent on largest number in column 2.
            var column2 = [testBoard[1][0], testBoard[1][1], testBoard[1][2], testBoard[1][3]];
            var maxNum = column2.sort(function (a, b) { return b - a })[0]; //biggest first

            if (maxNum == column2[2] || maxNum == column2[3]) { //backwards logic for some reason
                for (var j = 0; j < 4; j++) {
                    score += testBoard[2][j] * Math.pow(3, -17 + j + 5); //5 6 7 8    push numbers down 
                    score += testBoard[3][j] * Math.pow(3, -17 + j);     //0 1 2 3
                }
            }
            else {
                for (var j = 0; j < 4; j++) {
                    score += testBoard[2][j] * Math.pow(3, -17 + (3 - j) + 5); //8 7 6 5 
                    score += testBoard[3][j] * Math.pow(3, -17 + (3 - j));     //3 2 1 0
                }
            }

            //Penalize for covering smaller tiles in 1st column with larger tiles in 2nd column
            for (var i = 0; i < 3; i++)
                if (2 * testBoard[0][i] < testBoard[1][i])
                    if (!(j == 3 && board[0][2] >= 256))
                        score -= 10;

            if (testBoard == "False")
                return -10;
            if (generateMove(testBoard, "up") == "False" && 
                generateMove(testBoard, "down") == "False" && 
                generateMove(testBoard, "left") == "False" && 
                generateMove(testBoard, "right") == "False")
                return -10;
            else {
                return score;
            }
        }


        initialize();
        window.addEventListener('keydown', doKeyDown, true);
        window.addEventListener('click', addClickElementToBoard, true);
        window.addEventListener('contextmenu', addClickElementToBoard, false);

    </script>


</body>
</html>
